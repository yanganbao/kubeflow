# Releasing the training operator

## Prerequisite

1. Permissions
	- You need to be a member of release-team@kubeflow.org.
	- You need write permissions on the repository to create a release tag/branch.
	
2. Prepare your Github Token

3. Install Github python dependencies to generate changlog 
    ```
    pip install PyGithub
    ```

### Release Process

1. Make sure the last commit you want to release past `kubeflow-training-operator-postsubmit` testing.

1. Check out that commit (in this example, we'll use `6214e560`). 

1. Depends on what version you want to release,
    - Major or Minor version - Use the GitHub UI to cut a release branch and name the release branch `v{MAJOR}.${MINOR}-branch`
    - Patch version - You don't need to cut release branch.

1. Create a new PR against the release branch to change container image in manifest to point to that commit hash.  

    ```
    images:
    - name: kubeflow/training-operator
      newName: kubeflow/training-operator
      newTag: ${commit_hash}
    ``` 

    > note: post submit job will always build a new image using the `PULL_BASE_HASH` as image tag.

1. Create a tag and push tag to upstream.

    ```
    git tag v1.2.0
    git push upstream v1.2.0
    ```

1. Run following code and fetch online git commits from last release (v1.1.0) to current release (v1.2.0).

    ```
     git log v1.1.0..v1.2.0 --oneline
    ```
 
1. Copy above commit history to `release.py` and replace `<your_github_token>` with your Github token.
    Run this python scripts to generate changelogs.

    ```
    from github import Github
    import re
    
    
    class ChangelogGenerator:
        def __init__(self, github_repo):
            # Replace <your_github_token> with your Github Token
            self._github = Github('<your_github_token>')
            self._github_repo = self._github.get_repo(github_repo)
    
        def generate(self, pr_id):
            pr = self._github_repo.get_pull(pr_id)
    
            return "{title} ([#{pr_id}]({pr_link}), @{user})".format(
                title=pr.title,
                pr_id=pr_id,
                pr_link=pr.html_url,
                user=pr.user.login
            )
    
    
    # generated by `git log <oldTag>..<newTag> --oneline`
    payload = '''
    6f1e96c4 Update container image for v1.2.0 (#1328)
    47a74b73 add a specific version of tensorflow_datasets (#1305)
    e3061132 Remove vendor folder (#1288)
    eb362bd8 Fix invalid pointer when tfjob is deleted (#1285)
    0c41b273 fix get_logs pod_names type and iteration blocking (#1280)
    af5bdd58 Add job namespace to `tf_operator_jobs_*` counters (#1283)
    6fd9489e fix custom_api.delete_namespaced_custom_object args (#1281)
    c095f7a9 feat: upgrade kubeflow common and volcano version (#1276)
    13b17b0e Use remote Kustomize build option in standalone installation instructions (#1266)
    faf34868 fix: Remove the dup comment tag (#1274)
    9a297876 add podgroups rule in cluster-role.yaml (#1272)
    58c9bc4a Fix: the "follow" of TFJobClient.get_logs (#1254)
    3d9e7c8a Add task type annotation for pods when EnableGangScheduling is true. (#1268)
    8d179f70 Fix: Remove Github CD workflow (#1263)
    '''

    g = ChangelogGenerator("kubeflow/training-operator")
    for pr_match in re.finditer(r"#(\d+)", payload):
        pr_id = int(pr_match.group(1))
        print("* {}".format(g.generate(pr_id)))
    ```

1. Cut release from tags and copy results from last step. You can group commits into `Features`, `Bugs` etc. 
See example [v1.2.0 release](https://github.com/kubeflow/training-operator/releases/tag/v1.2.0)

1. Send a PR to update [CHANGELOG.md](../../CHANGELOG.md)
 